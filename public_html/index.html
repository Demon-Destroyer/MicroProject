<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Student Enrollment Form</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet"
              href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script
        src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    </head>
    <body>
        <div class="container">
            <h2>Student Enrollment Form</h2>
            <form id="empform" method="get">
                <div class="form-group">
                    <label for="rollno">Roll-No:</label>
                    <input type="text" class="form-control" name="rollno" id="rollno" onchange="getEmp()">
                </div>
                <div class="form-group">
                    <label for="sname">Student Name:</label>
                    <input type="text" class="form-control" id="sname" name="sname" disabled>
                </div>
                <div class="form-group">
                    <label for="sclass">Class:</label>
                    <input type="text" class="form-control" id="sclass" name="sclass" disabled>
                </div>
                <div class="form-group">
                    <label for="bdate">Birth-Date</label>
                    <input type="date" class="form-control" id="bdate" name="bdate" disabled>
                </div>
                <div class="form-group">
                    <label for="add">Address:</label>
                    <input type="text" class="form-control" id="add" name="add" disabled>
                </div>
                <div class="form-group">
                    <label for="endate">Enrollment-Date</label>
                    <input type="date" class="form-control" id="endate" name="endate" disabled>
                </div>

                <button type="button" class="btn btn-primary" id="save" onclick="saveData()" disabled>Save</button>
                <button type="button" class="btn btn-primary" id="change" onclick="changeData()" disabled>Update</button>
                <button type="button" class="btn btn-primary" id="reset" onclick="resetForm()" disabled>Reset</button>
            </form>
        </div>
        <script>

            var database = "SCHOOL-DB";
            var table = "STUDENT-TABLE";
            var baseurl = "http://api.login2explore.com:5577";
            var irlurl = "/api/irl";
            var imlurl = "/api/iml";
            var conntoken = "90933246|-31949278364580315|90950849";

            $("#rollno").focus();

            function saveRecNo2LS(jsonObj) {
                var lvData = JSON.parse(jsonObj.data);
                localStorage.setItem("recno", lvData.rec_no);
            }

            function getEmpIdAsJsonObj() {
                var roll = $("#rollno").val();
                var jsonStr = {
                    roll_no: roll
                };
                return JSON.stringify(jsonStr);
            }

            function fillData(jsonObj) {
                saveRecNo2LS(jsonObj);
                var record = JSON.parse(jsonObj.data).record;
                $("#sname").val(record.name);
                $("#sclass").val(record.class);
                $("#bdate").val(record.birth_date);
                $("#add").val(record.address);
                $("#endate").val(record.enrollment_date);
            }


            function resetForm() {
                $("#rollno").val("");
                $("#sname").val("");
                $("#sclass").val("");
                $("#bdate").val("");
                $("#add").val("");
                $("#endate").val("");
                $("#sname").prop("disabled", true);
                $("#sclass").prop("disabled", true);
                $("#bdate").prop("disabled", true);
                $("#add").prop("disabled", true);
                $("#endate").prop("disabled", true);
                $("#rollno").prop("disabled", false);
                $("#save").prop("disabled", true);
                $("#change").prop("disabled", true);
                $("#reset").prop("disabled", true);
                $("#rollno").focus();
            }

            function validateData() {

                var rollno = $("#rollno").val();
                var sname = $("#sname").val();
                var sclass = $("#sclass").val();
                var bdate = $("#bdate").val();
                var add = $("#add").val();
                var endate = $("#endate").val();

                if (rollno === "") {
                    alert("Roll-no is Required Value");
                    $("#rollno").focus();
                    return "";
                }

                if (sname === "") {
                    alert("Name is Required Value");
                    $("#sname").focus();
                    return "";
                }

                if (sclass === "") {
                    alert("Class Required Value");
                    $("#sclass").focus();
                    return "";
                }

                if (bdate === "") {
                    alert("Birthday is Required Value");
                    $("#bdate").focus();
                    return "";
                }

                if (add === "") {
                    alert("Address Required Value");
                    $("#add").focus();
                    return "";
                }

                if (endate === "") {
                    alert("Enrollment Date Required Value");
                    $("#endate").focus();
                    return "";
                }
                var jsonStrObj = {
                    roll_no: rollno,
                    name: sname,
                    class: sclass,
                    birth_date: bdate,
                    address: add,
                    enrollment_date: endate
                };
                return JSON.stringify(jsonStrObj);
            }

            function getEmp() {
                var empIdJsonObj = getEmpIdAsJsonObj();
                var getRequest = createGET_BY_KEYRequest(conntoken, database, table, empIdJsonObj);

                jQuery.ajaxSetup({async: false});
                var resJsonObj = executeCommandAtGivenBaseUrl(getRequest, baseurl, irlurl);
                jQuery.ajaxSetup({async: true});

                if (resJsonObj.status === 400) {
                    $("#save").prop("disabled", false);
                    $("#reset").prop("disabled", false);
                    $("#sname").prop("disabled", false);
                    $("#sclass").prop("disabled", false);
                    $("#bdate").prop("disabled", false);
                    $("#add").prop("disabled", false);
                    $("#endate").prop("disabled", false);

                    $("#sname").focus();
                } else if (resJsonObj.status === 200) {
                    $("#rollno").prop("disabled", true);
                    fillData(resJsonObj);

                    $("#change").prop("disabled", false);
                    $("#reset").prop("disabled", false);
                    $("#sname").prop("disabled", false);
                    $("#sclass").prop("disabled", false);
                    $("#bdate").prop("disabled", false);
                    $("#add").prop("disabled", false);
                    $("#endate").prop("disabled", false);
                    $("#sname").focus();
                }
            }

            function saveData() {
                var jsonStrObj = validateData();

                if (jsonStrObj === "") {
                    return "";
                }

                var putRequest = createPUTRequest(conntoken, jsonStrObj, database, table);
                alert(putRequest);

                jQuery.ajaxSetup({async: false});
                var resJsonObj = executeCommandAtGivenBaseUrl(putRequest, baseurl, imlurl);
                alert(JSON.stringify(resJsonObj));
                jQuery.ajaxSetup({async: true});

                resetForm();
                $("#rollno").focus();
            }

            function changeData() {
                $("#change").prop("disabled", true);
                jsonChg = validateData();
                var updateRequest = createUPDATERecordRequest(conntoken, jsonChg, database, table, localStorage.getItem("recno"));
                jQuery.ajaxSetup({async: false});
                var resJsonObj = executeCommandAtGivenBaseUrl(updateRequest, baseurl, imlurl);
                jQuery.ajaxSetup({async: true});
                console.log(resJsonObj);
                resetForm();
                $("#rollno").focus();
            }

        </script>
        <script src="https://login2explore.com/jpdb/resources/js/0.0.3/jpdb-commons.js"></script>
    </body>
</html>

